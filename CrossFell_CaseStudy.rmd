---
title: 'Statistics Case Study: Cross Fell Grazing 2013'
author: "CK"
date: "19 Sept 2017"
output:
  word_document: default
  html_notebook: default
---
Time run: `r Sys.time()`

```{r, echo=FALSE, message=FALSE, warning=FALSE}
### Packages
library(tidyverse)
library(knitr)
library(ggpubr) 
library(broom)
library(nortest)


###Load data
load(file="CrossFell.data.prepd.rda")

### Select data for analysis

ht.data <- filter(ht.data, taxon == "Vm")
ht.data$taxon <- droplevels(ht.data$taxon)
```

#Natural England Statistics Case Study 
##Analysis of Variance in a grazing impacts study at Cross Fell SSSI

**Study:** *Survey of Grazing Impact on Cross Fell Montane Heath and Analysis of Change 2003-2013, Martin D., Natural England, 2014*

## Background
Cross Fell is part of Kirkland Fell, one of five contiguous upland commons in eastern Cumbria that came into Countryside Stewardship Scheme (CSS) Agreement Between 2000 and 2003.  Under the terms of the agreement, stocking levels were reduced and shepherding introduced to further limit grazing pressure on sensitive habitats.  As part of the project, the area of montane heath on the summit plateau of Cross Fell was surveyed in October 2003. Attributes of the vegetation condition and species composition were recorded.  The survey was repeated in 2005, 2008, 2010 and 2013.

## Field Method

Surveyors measured vegetation height of a variety of taxa, including bilberry *Vaccinium myrtillus* on five sucessive surveys on montane grassland at Cross Fell in the North Pennines.  The surveys took place in 2003, 2005, 2008, 2010 and 2013.  Survey quadrats were randomly located each year.  There were different numbers of quadrats in each survey year.  
```{r, echo = FALSE}
kable(quad.n)

```

Quadrats were placed at the random points that fell within montane heath on Cross Fell.  The same set of random points was used in 2003 and 2005, but new sets generated in each of 2008, 2010 and 2013.
  
There is a record for each height measurement per year (although the quadrats are not labelled).  Up to four bilberry height measurements were taken in each quadrat.  

The number of measurements taken in each year is as follows: 
```{r, echo=FALSE}
kable(data.frame(table(ht.data$year)), col.names = c("year", "measurements"), align = "l")
```


## Data analysis and results
One of the desired outcomes of the intervention was a significant increase in bilberry height, as an indicator of favourable condition.  The bilberry height data was therefore analysed for differences in the mean height between years.  

**For each year** the following summary values of **vegetation height** were calculated: 

```{r, echo = FALSE}
####Height means: 
ht.means <- ht.data %>%
  group_by(year) %>% 
  summarise(mean = mean(height), median = median(height), sd = sd(height),
            n = length(height)) 

kable(ht.means)
```

Plotted this looks as follows:  

```{r, echo = FALSE}
#box plots by height and year for each taxon
ggplot(ht.data, aes(x = year, y= height)) +
  geom_boxplot() 
```


```{r, echo=FALSE}
#run Anderson Darling test for normality on each year in turn
norm <- ht.data %>%
  group_by(year) %>%
  do(broom::tidy(ad.test(.$height)))
```

The data was tested for normality using the Anderson Darling test.  Only the measurements in 2005 were not normally distributed  (A = `r round(norm$statistic[which(norm$year == 2005)], 4)`, p = `r round(norm$p.value[which(norm$year == 2005)], 4)`).  The other years' measurements were normally distributed (2003: A = `r round(norm$statistic[which(norm$year == 2003)], 4)`, p = `r round(norm$p.value[which(norm$year == 2003)], 4)`; 2008: A = `r round(norm$statistic[which(norm$year == 2008)], 4)`, p = `r round(norm$p.value[which(norm$year == 2008)], 4)`; 2010: A = `r round(norm$statistic[which(norm$year == 2010)], 4)`, p = `r round(norm$p.value[which(norm$year == 2010)], 4)`; 2013: A = `r round(norm$statistic[which(norm$year == 2013)], 4)`, p = `r round(norm$p.value[which(norm$year == 2013)], 4)`)

```{r, echo=FALSE}
#run Bartlett test for homogeneity of variances 
bart <- bartlett.test(height ~ year, data = ht.data)
```

The data were tested for homoscedasticity (homogeneity of variances) using the Bartlett Test. The variances were not found to be homogeneous (Bartlett's K-squared = `r bart$statistic`, p = `r bart$p.value`).  The data was found not to meet the requirements of homoscedasticity required for ANOVA so non-parametric testing was required.  

```{r, echo=FALSE}
#run Kruskall Wallace test
krusk <- kruskal.test(height ~ year, data = ht.data)
```
The mean difference vegetation height in each taxon was tested using the Kruskall Wallace rank sum test test. There was a significant difference between the means (Kruskal-Wallis chi-squared = `r krusk$statistic`, p = `r krusk$p.value`).   


```{r, echo = FALSE}
#run Wilcox test using function ggpubr::compare_means() to calculate and format significant differnce. 
wilc.pairw <- compare_means(formula = height ~ year, 
                          data = ht.data, 
                            method = "wilcox.test", paired = FALSE)

#add means
wilc.pairw <- wilc.pairw %>% 
  left_join(., select(ht.means, year, mean), by = c("group1" = "year")) %>% 
  rename(mean1 = mean)
wilc.pairw <- wilc.pairw %>% 
  left_join(., select(ht.means, year, mean), by = c("group2" = "year")) %>% 
  rename(mean2 = mean)
wilc.pairw$mean.diff <- wilc.pairw$mean2 - wilc.pairw$mean1
  
wilc.pairw <- filter(wilc.pairw, p < 0.05) #select only significant results.

#make vector of means
ht.means.vec <- ht.means$mean
names(ht.means.vec) <- ht.means$year
```
Having found significant differences, post-hoc testing using pairwise Wilcoxson rank sum tests (also known as Mann-Whitney U test) was carried out to identify and characterise the change. There earliest significant increase in vegetation height occurs in 2010.  There was a significant increase in mean height of `r round(wilc.pairw$mean.diff[1], 2)`cm between 2003 (mean = `r round(ht.means.vec["2003"], 2)`cm) and 2010 (mean = `r round(ht.means.vec["2010"], 2)`cm) (p = `r wilc.pairw$p.format[1]`), and in fact also between 2010 and all previous survey years (2005: height increase =  `r round(wilc.pairw$mean.diff[2], 2)`, p = `r wilc.pairw$p.format[2]`; 2008: height increase =  `r round(wilc.pairw$mean.diff[3], 2)`, p = `r wilc.pairw$p.format[3]`).  Although the mean height of bilberry subsequently decreased by `r round(wilc.pairw$mean.diff[7], 2)`cm between 2010 (mean = `r round(ht.means.vec["2010"], 2)`cm) and 2013 (mean = `r round(ht.means.vec["2013"], 2)`cm) (p = `r wilc.pairw$p.format[7]`), over the entire survey period there is an overall increase of `r round(wilc.pairw$mean.diff[4], 2)`cm between 2003 (mean = `r round(ht.means.vec["2003"], 2)`cm) and 2013 (mean = `r round(ht.means.vec["2013"], 2)`cm) (p = `r wilc.pairw$p.format[4]`).

This is shown in the graph below: 

```{r, echo= FALSE}
#generate list of brackets
my_comparisons <- list() 
for (i in 1:nrow(wilc.pairw)) {
  my_comparisons[[i]] <- c(wilc.pairw$group1[i], wilc.pairw$group2[i])
  }

#prepare plot
p <- ggplot(ht.data, aes(x = year, y = height)) +
  geom_boxplot()

# Add pairwise comparisons p-value to plot
p + stat_compare_means(comparisons = my_comparisons, 
                       label = "p.signif", 
                       hide.ns = FALSE)
```