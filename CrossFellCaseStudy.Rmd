---
title: 'Statistics Case Study: Cross Fell Grazing 2013'
author: "CK"
date: "24 August 2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###Time run
Time run: `r Sys.time()`

###Packages
```{r, echo=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(foreign)
library(knitr)
```

##Data preparation

###Import data - cover part
Import the csv file which I previously opened in Minitab and saved (probably wrongly in Unicode)
```{r, echo=T}
raw <- read.csv(file = "CF_COVER_2013.txt", sep = ",", quote = "",  header = T, skipNul = T)
```


###Wrangle data - cover
####Names
lets have a look at the names: 
```{r, echo=T}
names(raw)
```
They are a bit of a mess.  
We can strip out a lot automatically, and replace some of the more exotic characters.  Here I will remove the `X.` and the periods, and replace the first column name entirely.  
```{r}
names(raw) <- gsub("X.", "", names(raw))
names(raw) <- gsub("\\.", "", names(raw))
names(raw)[1] <- paste("Vmb03")
#names(raw)
```

####Strip
We've got some unnecessary summary columns: They all start with `C`.  We'll strip them out: 
```{r}
raw[,grep("C", names(raw))] <- NULL
#names(raw)
```


####Make tidy
Now lets put this into **tidy** format:

>each column a variable, each row an observation.    

In this case the observations are of percent cover, and they key (currently column names) define a taxon and a year.  
```{r}
cov.data <- gather(data = raw, key = "tax.surv", value = "cover", na.rm = TRUE, factor_key = TRUE)
head(cov.data) #have a look
dim(cov.data) #get dimensions
levels(cov.data$tax.surv) #check all the variables are there
```

Now we need to split the `tax.surv` column. 
```{r}
cov.data <- separate(data = cov.data, col = tax.surv, into = c("taxon", "year"), sep = -3)
cov.data$taxon <- as.factor(cov.data$taxon)
levels(cov.data$taxon)
head(cov.data)
summary(cov.data)
```

Finally sort out the `year` column:
```{r}
cov.data$year[which(cov.data$year=="03")] <- 2003
cov.data$year[which(cov.data$year=="05")] <- 2005
cov.data$year[which(cov.data$year=="08")] <- 2008
cov.data$year[which(cov.data$year=="10")] <- 2010
cov.data$year[which(cov.data$year=="13")] <- 2013

cov.data$year <- as.factor(cov.data$year)
levels(cov.data$year) <- c("2003", "2005", "2008", "2010", "2013")
```

we good?
```{r}
summary(cov.data)
```
**we good.**



###Import data - height 
Import the csv file which I previously opened in Minitab and saved (probably wrongly in Unicode)
```{r, echo=T}
raw <- read.csv(file = "CF_HT_2013.csv", sep = ",", quote = "",  header = T, skipNul = T)
```

###Wrangle data - height
####Names
lets have a look at the names: 
```{r, echo=T}
names(raw)
```
They are a bit of a mess.  
We can strip out a lot automatically, and replace some of the more exotic characters.  Here I will remove the `X.` and the periods, and replace the first column name entirely.  
```{r}
names(raw) <- gsub("X.", "", names(raw))
names(raw) <- gsub("\\.", "", names(raw))
names(raw) <- gsub("ht", "", names(raw))
names(raw)[1] <- "moss03"
#names(raw)
```

####Strip
We've got some unnecessary summary columns: They all start with `C`.  We'll strip them out: 
```{r}
raw[,grep("C", names(raw))] <- NULL
#names(raw)
```



####Make tidy
Now lets put this into **tidy** format:

>each column a variable, each row an observation.    

In this case the observations are of percent cover, and they key (currently column names) define a taxon and a year.  
```{r}
ht.data <- gather(data = raw, key = "tax.surv", value = "height", na.rm = TRUE, factor_key = TRUE)
head(ht.data) #have a look
dim(ht.data) #get dimensions
levels(ht.data$tax.surv) #check all the variables are there
```

Now we need to split the `tax.surv` column. 
```{r}
ht.data <- separate(data = ht.data, col = tax.surv, into = c("taxon", "year"), sep = -3)
ht.data$taxon <- as.factor(ht.data$taxon)
levels(ht.data$taxon)
head(ht.data)
summary(ht.data)
```

Finally sort out the `year` column:
```{r}
ht.data$year[which(ht.data$year=="03")] <- 2003
ht.data$year[which(ht.data$year=="05")] <- 2005
ht.data$year[which(ht.data$year=="08")] <- 2008
ht.data$year[which(ht.data$year=="10")] <- 2010
ht.data$year[which(ht.data$year=="13")] <- 2013

ht.data$year <- as.factor(ht.data$year)
levels(ht.data$year) <- c("2003", "2005", "2008", "2010", "2013")
```

*we good?*
```{r}
summary(ht.data)
```
**we good.**


###Import data - all quadrat data

Import minitab file
```{r, echo=T}
#raw <- read.table("cross fell cover all.MTP", quote="", comment.char="", skip = 2)
```
*not working, have asked DM for csv*

###Merge data

*we can't do this at the moment because we don't have the quadrat data*

###Contextual data

####Quadrats

Number of quadrats surveyed per year (taken from report)
```{r}
quad.n <- data.frame(year = c("2003", "2005", "2008", "2010", "2013"), n.total = c(42, 44, 20, 31, 56))
```

<!-- page break -->
----------

##Data analysis
###Exploratory data anlysis

ok, lets plot cover values: 
```{r}
ggplot(data = cov.data, mapping = aes(y = cover, x = year)) +
  geom_boxplot(aes(colour = taxon))
```

Looks good.  `moss` is most common, some sort of pattern maybe.  
Lets look at means: 
```{r}
cov.means <- cov.data %>%
  group_by(taxon, year) %>% 
  summarise(mean = mean(cover), median = median(cover), sd = sd(cover), present = length(cover[which(cover!=0)]), n = length(cover))
kable(cov.means, digits = 2, caption = "Mean percent cover")
```

And lets plot vegetation heights: 
```{r}
ggplot(data = ht.data, mapping = aes(y = height, x = year)) +
  geom_boxplot(aes(colour = taxon))
```

  
Height means: 
```{r}
ht.means <- ht.data %>%
  group_by(taxon, year) %>% 
  summarise(mean = mean(height), median = median(height), sd = sd(height), present = length(height[which(height!=0)]), n = length(height)) %>% 
  mutate_if(is.numeric, funs(round(., 2)))
kable(ht.means, digits = 2, caption = "Mean vegetation height")
```

Now lets recreate the table of mean heights from the report (Table 1)
```{r}
Table1 <- spread(data = select(.data = ht.means, taxon, year, mean), 
       key = year, 
       value = mean) 
knitr::kable(Table1, digits = 2, caption = "Table 1: Mean height of key species groups measured in each survey year")
```



Lets try to calculate frequencies
```{r}
freq <- cov.means[,c("taxon", "year", "present", "n")]
freq <- full_join(freq, quad.n, by = "year")
freq$freq.n.total <- freq$present / freq$n.total
freq$freq.n <- freq$present / freq$n
kable(freq, digits = 2, caption = "Frequency: number and proportion of quadrats in which taxon was found")
```

Problems: 
* the reported quadrat number for 2010 (31) is lower than the max number of observations we have (33).  Will need to check the full data when we get it. For the time being we'll use `freq.n` the total number of observations calculated from the number of records (including 0 values), rather than `n` the reported number.

* the data doesn't quite tally with the report, e.g. bilberry in 2013 was found in 28 quadrats, but report says 30.  

```{r}
TableFreq <- spread(data = select(.data = freq, taxon, year, freq.n), 
       key = year, 
       value = freq.n)
knitr::kable(TableFreq, digits = 2, caption = "Frequency: proportion of quadrats in which taxon was found")
```

